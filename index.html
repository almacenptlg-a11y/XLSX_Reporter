<!DOCTYPE html>
<html lang="es" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>XLSX_Reporter</title>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="styles.css">
</head>

<body>

  <div class="drag-overlay" id="dragOverlay">
    <div style="text-align: center;">
      <i class="ph ph-file-arrow-up" style="font-size: 48px;"></i>
      <p>Suelta el archivo aquí para abrirlo</p>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <div class="modal-overlay" id="sheetModal">
    <div class="modal-card">
      <h3 style="margin:0; font-size:16px;">Seleccionar Hoja</h3>
      <p style="margin:0; font-size:13px; color:var(--text-muted);">El archivo contiene varias hojas. Selecciona cuál
        deseas cargar:</p>
      <div class="sheet-list" id="sheetList"></div>
      <button class="btn" style="align-self: flex-end;" id="btnCloseSheetModal">Cancelar</button>
    </div>
  </div>

  <div class="modal-overlay" id="exportModal">
    <div class="modal-card">
      <h3 style="margin:0; font-size:16px;">Confirmar Datos del Reporte</h3>
      <p style="margin:0; font-size:13px; color:var(--text-muted);">Verifica la información antes de generar el archivo.
      </p>

      <div style="display:flex; flex-direction:column; gap:12px; margin-top:10px;">
        <div>
          <label style="font-size:11px; font-weight:700; color:var(--text-muted); display:block; margin-bottom:4px; text-transform:uppercase;">Título
            del Documento</label>
          <input type="text" class="form-input" id="confirmTitle" placeholder="Título del reporte">
        </div>
        <div>
          <label style="font-size:11px; font-weight:700; color:var(--text-muted); display:block; margin-bottom:4px; text-transform:uppercase;">Autor</label>
          <input type="text" class="form-input" id="confirmAuthor" placeholder="Nombre del autor">
        </div>
      </div>

      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
        <button class="btn" id="btnCancelExport">Cancelar</button>
        <button class="btn btn-primary" id="btnConfirmExport">
          <i class="ph ph-check"></i> Confirmar y Exportar
        </button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="structureModal">
    <div class="modal-card" style="width: 800px; max-width: 95%;">
      <div class="modal-header">
        <h3 class="modal-title">Definir Estructura de Datos</h3>
      </div>
      <div class="modal-body" style="padding: 16px;">
        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">
          1. Haz <strong>clic en la fila</strong> que contiene los títulos de las columnas (Encabezado).<br>
          2. (Opcional) Indica cuántas filas ignorar al final (totales, notas al pie).
        </p>

        <div style="border: 1px solid var(--border); border-radius: 6px; overflow: auto; max-height: 400px; margin-bottom: 16px; background: var(--bg-body);">
          <table id="previewTable" style="width: 100%; border-collapse: collapse;">
          </table>
        </div>

        <div style="display: flex; gap: 16px; align-items: flex-end; justify-content: space-between; border-top: 1px solid var(--border); padding-top: 16px;">
          <div style="display: flex; gap: 10px; align-items: center;">
            <div>
              <label style="font-size: 11px; font-weight: 700; display: block; margin-bottom: 4px;">FILAS A OMITIR AL FINAL</label>
              <input type="number" id="footerSkipCount" class="form-input" value="0" min="0" style="width: 80px;">
            </div>
            <div style="font-size: 12px; color: var(--text-muted);">
              Fila Encabezado: <strong id="selectedHeaderIndexDisplay" style="color: var(--primary);">Auto (1)</strong>
            </div>
          </div>

          <div style="display: flex; gap: 8px;">
            <button class="btn" id="btnCancelStructure">Cancelar</button>
            <button class="btn btn-primary" id="btnConfirmStructure">
              <i class="ph ph-check"></i> Procesar Datos
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="columnContextMenu" class="dropdown" style="width: 280px;"></div>

  <div class="app-wrapper">
    <header class="app-header">
      <div class="brand">
        <i class="ph ph-database"></i>
        <span>Generador de Reportes</span>
      </div>

      <div class="toolbar-actions">
        <div class="input-group">
          <i class="ph ph-magnifying-glass"></i>
          <input type="text" class="form-input" id="globalSearch" placeholder="Buscar..." disabled>
        </div>
        <div class="input-group">
          <i class="ph ph-tag" style="color: var(--accent);"></i>
          <input type="text" class="form-input" id="reportTitle" placeholder="Título" value="Reporte">
        </div>
        <div class="input-group">
          <i class="ph ph-user" style="color: var(--success);"></i>
          <input type="text" class="form-input" id="reportAuthor" placeholder="Autor" value="Usuario">
        </div>

        <div style="position: relative;">
          <button class="btn" id="btnExport" onclick="app.toggleMenu('exportMenu')">
            <i class="ph ph-export"></i> Exportar
          </button>

          <div id="exportMenu" class="dropdown" style="right: 0; min-width: 180px;">
            <div class="dropdown-item" onclick="app.openCsvMapper()">
              <i class="ph ph-table" style="color:#d97706"></i> CSV Personalizado
            </div>
            <div style="height:1px; background:var(--border); margin:4px 0;"></div>
            <div class="dropdown-item" onclick="app.exportTo('xlsx')">
              <i class="ph ph-file-xls" style="color:#16a34a"></i> Excel (.xlsx)
            </div>
            <div class="dropdown-item" onclick="app.exportTo('pdf')">
              <i class="ph ph-file-pdf" style="color:#dc2626"></i> PDF (.pdf)
            </div>
            <div class="dropdown-item" onclick="app.exportTo('html')">
              <i class="ph ph-code" style="color:#2563eb"></i> HTML (.html)
            </div>
          </div>

        </div>

        <div style="position: relative;">
          <button class="btn" id="btnColumns" onclick="app.toggleMenu('colMenu')">
            <i class="ph ph-columns"></i>Seleccionar Columnas
          </button>
          <div id="colMenu" class="dropdown" style="right: 0;">
            <div class="col-picker-content">
              <div style="display:flex; gap:5px;">
                <button class="btn btn-sm" style="flex:1" onclick="app.toggleAllColumns(true)">Mostrar Todo</button>
                <button class="btn btn-sm" style="flex:1" onclick="app.toggleAllColumns(false)">Ocultar Todo</button>
              </div>
              <input type="text" class="form-input-sm" placeholder="Buscar columna..." oninput="app.filterColumnList(this.value)">
              <div class="col-list-wrapper" id="colListContainer"></div>
            </div>
          </div>
        </div>

        <div class="divider" style="width:1px; height:24px; background:var(--border);"></div>
        <button class="btn btn-icon" onclick="app.toggleTheme()" title="Cambiar Tema"><i class="ph ph-moon" id="themeIcon"></i></button>
      </div>

      <div style="position: relative;">
        <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" style="position:absolute; width:100%; height:100%; opacity:0; cursor:pointer;">
        <button class="btn btn-primary">
          <i class="ph ph-download-simple"></i> Cargar Archivo
        </button>
      </div>

    </header>

    <div id="filterSummaryBar" class="active-filters-bar hidden"></div>

    <main class="data-container">
      <div id="loadingState" class="empty-state hidden">
        <div class="loader"></div>
        <p style="margin-top: 15px;">Procesando archivo...</p>
      </div>

      <div id="emptyState" class="empty-state">
        <i class="ph ph-file-csv empty-icon"></i>
        <h2>No hay datos cargados</h2>
        <p>Selecciona un archivo Excel (.xlsx) o CSV para comenzar el análisis.</p>
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()" style="margin-top: 20px;">
          Seleccionar Archivo
        </button>
      </div>

      <div id="tableWrapper" class="table-wrapper hidden">
        <table id="mainTable">
          <thead id="tHead"></thead>
          <tbody id="tBody"></tbody>
          <tfoot id="tFoot"></tfoot>
        </table>
      </div>
    </main>

    <footer class="footer-bar hidden" id="appFooter">
      <div id="statusMsg">0 registros</div>
      <div class="pagination">
        <span class="page-info">Página <strong id="currPage">1</strong> de <strong id="totalPages">1</strong></span>
        <button class="btn btn-icon" id="btnPrev" disabled><i class="ph ph-caret-left"></i></button>
        <button class="btn btn-icon" id="btnNext" disabled><i class="ph ph-caret-right"></i></button>
        <select id="pageSize" class="form-input" style="width: auto; padding: 4px 8px;">
          <option value="100">100 / pág</option>
          <option value="500">500 / pág</option>
          <option value="1000">1000 / pág</option>
        </select>
      </div>
    </footer>
  </div>

  <div class="modal-overlay" id="csvMapModal">
    <div class="modal-card" style="width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">CSV AlmacenPT</h3>
      </div>
      <div class="modal-body" style="padding: 20px; gap: 16px;">
        <p style="font-size:13px; color:var(--text-muted);">Asigna las columnas de tu archivo a los campos requeridos.</p>

        <div class="mapping-row">
          <label class="mapping-label">1. LOCALIDAD</label>
          <div style="display:flex; flex-direction:column; gap:6px;">
            <select id="mapLocalidad" class="form-select"></select>
            <div style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="chkManualLocalidad" onchange="app.toggleLocalidadInput()">
              <label for="chkManualLocalidad" style="font-size:12px; cursor:pointer">No existe en archivo (Usar valor fijo)</label>
            </div>
            <input type="text" id="inputManualLocalidad" class="form-input hidden" placeholder="Escribe la localidad (ej: LIMA)">
          </div>
        </div>

        <div class="mapping-row">
          <label class="mapping-label">2. SCAN_CODE</label>
          <select id="mapScanCode" class="form-select"></select>
        </div>

        <div class="mapping-row">
          <label class="mapping-label">3. PRODUCTO X</label>
          <select id="mapProducto" class="form-select"></select>
        </div>

        <div class="mapping-row">
          <label class="mapping-label">4. PEDIDO</label>
          <select id="mapPedido" class="form-select"></select>
        </div>

        <div class="mapping-row">
          <label class="mapping-label">5. ORDEN DE COMPRA</label>
          <div style="display:flex; flex-direction:column; gap:6px;">
            <select id="mapOrdenCompra" class="form-select"></select>

            <div style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="chkAutoOC" onchange="app.toggleAutoOC()">
              <label for="chkAutoOC" style="font-size:12px; cursor:pointer">Generar ID Automático (Fecha_Hora)</label>
            </div>

            <input type="text" id="previewAutoOC" class="form-input hidden" disabled style="background:var(--bg-body); color:var(--text-muted); font-family:monospace;">
          </div>

          <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
            <button class="btn" onclick="document.getElementById('csvMapModal').classList.remove('active')">Cancelar</button>
            <button class="btn btn-primary" onclick="app.generateCustomCSV()">
              <i class="ph ph-download-simple"></i> Descargar CSV
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="script.js"></script>
</body>

</html>
